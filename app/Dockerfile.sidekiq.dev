ARG RUBY_VERSION=3.2.2
ARG RAILS_MASTER_KEY
FROM docker.io/library/ruby:$RUBY_VERSION-slim

WORKDIR /app

# Install base packages
# The SIDEKIQ server is mean to run all the code in the background
# therefor we need to install all the packages that are needed to run the code
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y \
      curl \
      gcc g++ make \
      libjemalloc2 \
      libvips \
      default-mysql-client \
      default-libmysqlclient-dev \
      nodejs \
      python3 \
      # nsjail dependencies
      autoconf \
      bison \
      flex \
      git \
      libprotobuf-dev \
      libnl-route-3-dev \
      libtool \
      pkg-config \
      protobuf-compiler \
      uidmap

# Build and install nsjail from source
RUN git clone --depth 1 https://github.com/google/nsjail.git /tmp/nsjail && \
    cd /tmp/nsjail && \
    make && \
    mv /tmp/nsjail/nsjail /usr/local/bin/ && \
    rm -rf /tmp/nsjail

# Create chroot directory structure for isolated execution
RUN mkdir -p /chroot && \
    mkdir -p /chroot/bin && \
    mkdir -p /chroot/lib && \
    mkdir -p /chroot/lib64 && \
    mkdir -p /chroot/usr && \
    mkdir -p /chroot/usr/bin && \
    mkdir -p /chroot/usr/lib && \
    mkdir -p /chroot/tmp && \
    mkdir -p /chroot/workspace && \
    mkdir -p /chroot/etc && \
    chmod 1777 /chroot/tmp

# Copy shell and basic utilities to chroot
RUN cp /bin/sh /chroot/bin/ && \
    cp /bin/dash /chroot/bin/ 2>/dev/null || true && \
    ldd /bin/sh | grep "=> /" | awk '{print $3}' | xargs -I '{}' cp -v '{}' /chroot/lib/ 2>/dev/null || true

# Copy required binaries and libraries for Python
RUN cp /usr/bin/python3 /chroot/usr/bin/ && \
    ldd /usr/bin/python3 | grep "=> /" | awk '{print $3}' | xargs -I '{}' cp -v '{}' /chroot/usr/lib/ 2>/dev/null || true

# Copy Python libraries
RUN cp -r /usr/lib/python3* /chroot/usr/lib/ 2>/dev/null || true

# Copy required binaries and libraries for Node.js
RUN cp /usr/bin/node /chroot/usr/bin/ && \
    ldd /usr/bin/node | grep "=> /" | awk '{print $3}' | xargs -I '{}' cp -v '{}' /chroot/usr/lib/ 2>/dev/null || true

# Copy required binaries and libraries for Ruby
RUN cp /usr/local/bin/ruby /chroot/usr/bin/ && \
    ldd /usr/local/bin/ruby | grep "=> /" | awk '{print $3}' | xargs -I '{}' cp -v '{}' /chroot/usr/lib/ 2>/dev/null || true && \
    cp -r /usr/local/lib/ruby /chroot/usr/lib/ 2>/dev/null || true

# Copy GCC and G++ for compiled languages
RUN cp /usr/bin/gcc /chroot/usr/bin/ && \
    cp /usr/bin/g++ /chroot/usr/bin/ && \
    cp /usr/bin/as /chroot/usr/bin/ && \
    cp /usr/bin/ld /chroot/usr/bin/ && \
    ldd /usr/bin/gcc | grep "=> /" | awk '{print $3}' | xargs -I '{}' cp -v '{}' /chroot/usr/lib/ 2>/dev/null || true && \
    ldd /usr/bin/g++ | grep "=> /" | awk '{print $3}' | xargs -I '{}' cp -v '{}' /chroot/usr/lib/ 2>/dev/null || true

# Copy essential libraries
RUN cp -r /lib/x86_64-linux-gnu/* /chroot/lib/ 2>/dev/null || true && \
    cp -r /usr/lib/x86_64-linux-gnu/* /chroot/usr/lib/ 2>/dev/null || true && \
    cp -r /lib64/* /chroot/lib64/ 2>/dev/null || true

# Fix the dynamic linker symlink to use relative path
RUN rm -f /chroot/lib64/ld-linux-x86-64.so.2 && \
    ln -s ../lib/ld-linux-x86-64.so.2 /chroot/lib64/ld-linux-x86-64.so.2

# Create a nobody user in chroot (for running untrusted code)
RUN echo "nobody:x:65534:65534:Nobody:/:/bin/false" > /chroot/etc/passwd

# Set production environment
ENV RAILS_ENV="development" \
    BUNDLE_DEPLOYMENT="0" \
    BUNDLE_PATH="/usr/local/bundle"

# Install packages needed to build gems
RUN apt-get update -qq && \
    apt-get install --no-install-recommends -y build-essential git pkg-config && \
    rm -rf /var/lib/apt/lists /var/cache/apt/archives

# Install application gems
COPY . .

RUN bundle install && \
    rm -rf ~/.bundle/ "${BUNDLE_PATH}"/ruby/*/cache "${BUNDLE_PATH}"/ruby/*/bundler/gems/*/.git && \
    bundle exec bootsnap precompile --gemfile

# Precompile bootsnap code for faster boot times
RUN bundle exec bootsnap precompile app/ lib/

# RUN SECRET_KEY_BASE_DUMMY=1 ./bin/rails assets:precompile

# Start the server by default, this can be overwritten at runtime
EXPOSE 3000
CMD ["bin/rails", "server", "-b", "0.0.0.0", "-p", "3000"]
