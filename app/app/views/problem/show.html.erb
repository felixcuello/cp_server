<div class="page-container">
  <div class="problem-detail-container" data-controller="submission-modal" data-submission-modal-problem-id-value="<%= @problem.id %>">

    <!-- Contest Banner -->
    <% if @contest %>
      <div class="contest-banner">
        <div class="contest-banner-content">
          <div>
            <strong>Contest:</strong>
            <%= link_to @contest.name, contest_path(@contest), class: "contest-link", data: { turbo: false } %>
            <% if @contest_active %>
              <span class="contest-status-badge active">Active</span>
            <% elsif @contest.ended? %>
              <span class="contest-status-badge ended">Ended</span>
            <% else %>
              <span class="contest-status-badge upcoming">Upcoming</span>
            <% end %>
          </div>
          <div class="contest-banner-actions">
            <%= link_to "View Contest", contest_path(@contest), class: "btn-secondary btn-small", data: { turbo: false } %>
            <% if @is_participant && (@contest_active || @contest.ended?) %>
              <%= link_to "Standings", standings_contest_path(@contest), class: "btn-secondary btn-small", data: { turbo: false } %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <!-- Submission Modal -->
    <div class="submission-modal-backdrop"
         data-submission-modal-target="modal"
         data-action="click->submission-modal#closeOnBackdrop"
         tabindex="-1">
      <div class="submission-modal">
        <button class="modal-close-btn" data-action="click->submission-modal#close">
          Ã—
        </button>

        <div class="modal-icon-container">
          <div class="modal-icon" data-submission-modal-target="icon">âœ“</div>
        </div>

        <h2 class="modal-title" data-submission-modal-target="title">Success!</h2>
        <p class="modal-message" data-submission-modal-target="message">Your solution passed all test cases!</p>

        <div class="modal-actions">
          <button class="modal-btn modal-btn-secondary"
                  data-submission-modal-target="tryAgainBtn"
                  data-action="click->submission-modal#tryAgain">
            Try Again
          </button>
          <button class="modal-btn modal-btn-primary"
                  data-submission-modal-target="viewSubmissionsBtn"
                  data-action="click->submission-modal#viewSubmissions">
            View Submissions
          </button>
        </div>

        <div class="modal-hint">
          Press <kbd>ESC</kbd> to close or <kbd>Enter</kbd> to view submissions
        </div>
      </div>
    </div>

    <!-- Split View: Description | Code Editor -->
    <div class="problem-split-view"
         data-controller="resize code-editor"
         data-code-editor-problem-id-value="<%= @problem.id %>"
         data-code-editor-testing-mode-value="<%= @problem.testing_mode %>">

      <!-- Left Pane: Problem Description with Tabs + Test Results -->
      <div class="problem-left-pane-wrapper"
           data-resize-target="leftPane">

        <!-- Top: Problem Description -->
        <div class="problem-description-pane"
             data-controller="problem-tabs"
             data-resize-target="leftTopPane">
          <!-- Tabs -->
          <div class="problem-tabs">
            <button class="tab active" data-tab="description" data-problem-tabs-target="tab" data-action="click->problem-tabs#switch">
              <%= t('problem.description') %>
            </button>
            <% if @user_submissions&.any? %>
              <button class="tab" data-tab="submissions" data-problem-tabs-target="tab" data-action="click->problem-tabs#switch">
                <%= t('problem.my_submissions') %>
              </button>
            <% end %>
          </div>

          <!-- Description Tab -->
          <div class="tab-panel active" data-panel="description" data-problem-tabs-target="panel">
            <!-- Problem Header -->
            <div class="problem-detail-header">
              <h1><%= @problem.id %>. <%= @problem.translated_title %></h1>

              <div class="problem-meta">
                <span class="problem-difficulty-<%= @problem.difficulty %>">
                  <%= t("problems.filters.#{@problem.difficulty}") %>
                </span>

                <% @problem.tags.each do |tag| %>
                  <span class="problem-tag"><%= tag.name %></span>
                <% end %>

                <div class="meta-item">
                  <strong><%= t('problem.time_limit') %>:</strong> <%= @problem.time_limit_sec %> <%= t('problem.sec') %>
                </div>

                <div class="meta-item">
                  <strong><%= t('problem.memory_limit') %>:</strong> <%= @problem.memory_limit_kb %> <%= t('problem.kb') %>
                </div>
              </div>
            </div>

            <!-- Problem Description (Markdown) -->
            <div class="problem-content">
              <%= markdown(@problem.translated_description) %>
            </div>

            <!-- Function Signature (for function-based problems) -->
            <% if @problem.function_based? %>
              <div class="function-signature-section">
                <h3><%= t('problem.function_to_implement') %></h3>
                <% if @problem.problem_templates.first&.function_signature.present? %>
                  <div class="function-signature-code">
                    <code><%= @problem.problem_templates.first.function_signature %></code>
                  </div>
                <% end %>
              </div>
            <% end %>

            <!-- Examples -->
            <div class="examples-section">
              <h2><%= t('problem.examples') %></h2>

              <% @problem.examples.where(is_hidden: false).each_with_index do |example, idx| %>
                <div class="example-card">
                  <div class="example-header">
                    <h4><%= t('problem.example') %> <%= idx + 1 %></h4>
                  </div>

                  <div class="example-content">
                    <% if @problem.function_based? %>
                      <!-- Function-based: Show description instead of output -->
                      <% if example.description.present? %>
                        <div class="example-block">
                          <%= example.description %>
                        </div>
                      <% else %>
                        <div class="example-block">
                          <h5><%= t('problem.input') %>:</h5>
                          <div class="example-code"><%= example.input %></div>
                        </div>
                      <% end %>
                    <% else %>
                      <!-- STDIN/STDOUT: Show input and output -->
                      <div class="example-block">
                        <h5><%= t('problem.input') %>:</h5>
                        <div class="example-code"><%= example.input %></div>
                      </div>

                      <div class="example-block">
                        <h5><%= t('problem.output') %>:</h5>
                        <div class="example-code"><%= example.output %></div>
                      </div>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>

            <!-- Constraints -->
            <div class="problem-content">
              <h2><%= t('problem.constraints') %></h2>
              <ul>
                <% @problem.constraints.order(:sort_order).each do |constraint| %>
                  <li><%= constraint.translated_description %></li>
                <% end %>
              </ul>
            </div>

            <!-- Problem Statistics -->
            <div class="problem-stats">
              <div class="stat-item">
                <div class="stat-label"><%= t('problem.accepted') %></div>
                <div class="stat-value"><%= @total_accepted %></div>
              </div>
              <div class="stat-item">
                <div class="stat-label"><%= t('problem.submissions_count') %></div>
                <div class="stat-value"><%= @total_submissions %></div>
              </div>
              <div class="stat-item">
                <div class="stat-label"><%= t('problem.acceptance_rate') %></div>
                <div class="stat-value"><%= @acceptance_rate %>%</div>
              </div>
            </div>

            <!-- Similar Problems -->
            <% if @similar_problems.any? %>
              <div class="similar-problems">
                <h3><%= t('problem.similar_problems') %></h3>
                <% @similar_problems.each do |similar| %>
                  <div class="similar-problem-item" onclick="window.location='<%= problem_path(similar) %>'">
                    <%= link_to problem_path(similar), data: { turbo: false } do %>
                      <%= similar.id %>. <%= similar.translated_title %>
                    <% end %>
                    <span class="problem-difficulty-<%= similar.difficulty %>">
                      <%= t("problems.filters.#{similar.difficulty}") %>
                    </span>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>

          <!-- Submissions Tab -->
          <% if @user_submissions&.any? %>
            <div class="tab-panel" data-panel="submissions" data-problem-tabs-target="panel">
              <h2><%= t('problem.my_submissions') %></h2>

              <% if @best_submission %>
                <div style="padding: 15px; background-color: var(--status-accepted); color: white; border-radius: 8px; margin-bottom: 20px;">
                  <strong>âœ“ <%= t('problem.best_submission') %>:</strong>
                  <%= @best_submission.time_used.round(3) %> <%= t('problem.sec') %> in <%= @best_submission.programming_language.name %>
                </div>
              <% end %>

              <div class="submission-history">
                <% @user_submissions.each do |submission| %>
                  <%= link_to submission_detail_path(submission), class: "submission-item-link" do %>
                    <div class="submission-item">
                      <div class="submission-info">
                        <span class="submission-status-<%= submission.status.downcase.gsub(/\s+/, '-') %>">
                          <%= submission.status.upcase %>
                        </span>
                        <span class="submission-lang"><%= submission.programming_language.name %></span>
                        <span class="submission-time">
                          <%= time_ago_in_words(submission.created_at) %> <%= t('problem.ago') %>
                        </span>
                      </div>
                      <% if submission.time_used %>
                        <div><%= submission.time_used.round(3) %> <%= t('problem.sec') %></div>
                      <% end %>
                    </div>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>

        <!-- Vertical Resizer (between description and test results) -->
        <div class="left-pane-vertical-resizer" data-resize-target="leftVerticalResizer"></div>

        <!-- Bottom: Test Results Section -->
        <div class="test-results-container"
             data-code-editor-target="testResults"
             data-resize-target="leftBottomPane"
             style="display: none;">
          <!-- Results will be inserted here by JavaScript -->
        </div>
      </div>

      <!-- Horizontal Resizer -->
      <div class="problem-split-resizer" data-resize-target="resizer"></div>

      <!-- Right Pane: Code Editor (full height) -->
      <div class="problem-editor-pane"
           data-resize-target="rightPane">

        <div class="editor-section">
          <!-- Editor Header -->
          <div class="editor-header">
            <div class="editor-header-left">
              <span style="font-weight: 600; color: var(--text-heading);"><%= t('problem.code') %></span>
              <select data-code-editor-target="languageSelect" data-action="change->code-editor#changeLanguage">
                <% @languages.each_with_index do |language, index| %>
                  <option value="<%= language.id %>" data-lang="<%= language.name.downcase %>" <%= 'selected' if index == 0 %>>
                    <%= language.name %>
                  </option>
                <% end %>
              </select>
            </div>
            <div class="editor-header-actions">
              <button class="btn-test" data-action="click->code-editor#test">
                â–¶ <%= t('problem.run_code') %>
              </button>
              <button class="btn-secondary" data-action="click->code-editor#resetCode">
                ðŸ”„ <%= t('problem.reset_code') %>
              </button>
              <button class="btn-primary" data-action="click->code-editor#submit">
                <%= t('problem.submit_solution') %>
              </button>
            </div>
          </div>

          <!-- Monaco Editor Container -->
          <div class="editor-container" data-code-editor-target="editor"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Monaco Editor -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
<script>
  // Configure and load Monaco Editor
  if (typeof require !== 'undefined') {
    require.config({
      paths: {
        vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs'
      }
    });

    // Make Monaco globally available
    window.monacoLoaded = new Promise((resolve) => {
      require(['vs/editor/editor.main'], function() {
        console.log('Monaco Editor loaded successfully');
        window.monacoReady = true;
        resolve();
      });
    });
  }
</script>
