<!DOCTYPE html>
<html class="preload">
  <head>
    <title><%= content_for(:title) || "UP | Competitive Programming Platform" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="<%= content_for(:title) || "UP Competitive Programming Service" %>">
    <meta property="og:description" content="<%= content_for(:description) || "UP - Competitive Programming Platform" %>">
    <meta property="og:image" content="<%= request.base_url %>/icon.png">
    <meta property="og:url" content="<%= request.original_url %>">
    <meta property="og:site_name" content="UP Competitive Programming Service">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="<%= content_for(:title) || "UP Competitive Programming Service" %>">
    <meta name="twitter:description" content="<%= content_for(:description) || "UP - Competitive Programming Platform" %>">
    <meta name="twitter:image" content="<%= request.base_url %>/icon.png">

    <%= yield :head %>

    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <!-- KaTeX for LaTeX rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <script>
      // Initialize theme immediately to prevent flash
      (function() {
        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
      })();
      
      // Initialize KaTeX rendering when DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        if (typeof renderMathInElement !== 'undefined') {
          renderMathInElement(document.body, {
            delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false}
            ]
          });
        }
      });
    </script>
    
    <%= javascript_importmap_tags %>
  </head>

  <body class="main-body">
    <% unless request.headers["Turbo-Frame"] || request.path == "/users/sign_in" %>
      <!-- Upcoming Contest Banner -->
      <% if user_signed_in? %>
        <% upcoming_contest = Contest.where('start_time > ?', Time.current).order(:start_time).first %>
        <% if upcoming_contest %>
          <div class="upcoming-contest-banner" data-controller="contest-countdown" 
               data-contest-countdown-start-time-value="<%= upcoming_contest.start_time.to_i * 1000 %>">
            <div class="banner-content">
              <div class="banner-left">
                <span class="banner-icon">üèÜ</span>
                <div class="banner-text">
                  <strong><%= link_to upcoming_contest.name, contest_path(upcoming_contest), class: "banner-link", data: { turbo: false } %></strong>
                  <span class="banner-date">starts <%= upcoming_contest.start_time.strftime("%B %d, %Y at %I:%M %p") %></span>
                </div>
              </div>
              <div class="banner-countdown">
                <span class="countdown-label">Starts in:</span>
                <span class="countdown-value" data-contest-countdown-target="days">00</span>d
                <span class="countdown-value" data-contest-countdown-target="hours">00</span>h
                <span class="countdown-value" data-contest-countdown-target="minutes">00</span>m
                <span class="countdown-value" data-contest-countdown-target="seconds">00</span>s
              </div>
              <div class="banner-right">
                <%= link_to "View Contest", contest_path(upcoming_contest), class: "banner-button", data: { turbo: false } %>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
      
      <%= render partial: 'shared/navbar' %>
    <% end %>
    
    <div id="flash-messages">
      <% if flash[:notice] %>
        <div class="flash notice"><%= flash[:notice] %></div>
      <% elsif flash[:alert] %>
        <div class="flash alert"><%= flash[:alert] %></div>
      <% end %>
    </div>

    <%= yield %>
  </body>
</html>
